<!doctype html>
<html>
  <head>
    <title>Register for the health app</title>
    <base href="/usr/365/">
    <link rel="stylesheet" type="text/css" href="main.css" />
  </head>

  <body>
    <p><a href="./">Home</a></p>
    <h1>
      <%= self ? "Your Profile" : (user.username + "'s Profile") %>
    </h1>

    <p><strong>Username:</strong> <%= user.username %></p>

    <!-- checking if there are more names -->
    <% if (user.first_name || user.last_name) { %> 
      <p><strong>Name:</strong> 
        <%= user.first_name ? user.first_name : '' %> 
        <%= user.last_name ? user.last_name : '' %>
      </p>
    <% } %>

    <!-- Logic for Friend Buttons: Only show if NOT viewing your own profile -->
    <% if (!self) { %> 
      
      <% 
        const friendship = friends.find(f => 
          (f.user_id == loggedInUserId && f.friend_id == user.id) ||
          (f.friend_id == loggedInUserId && f.user_id == user.id)
        );

        const isRecipientPending = friends.find(f => 
          f.user_id == user.id && f.friend_id == loggedInUserId && f.status == 'pending'
        );
      %>

      <div class="friend-actions">
        <% if (!friendship) { %> 
          <!--  No friendship exists, show Add Button -->
          <form method="POST" action="friends/add">
            <input type="hidden" name="friendId" value="<%= user.id %>" />
            <input type="hidden" name="friendUsername" value="<%= user.username %>" />
            <input type="submit" value="Add Friend" />
          </form>

        <% } else if (isRecipientPending) { %> 
          <!-- They sent user a request, show Accept Button -->
          <form method="POST" action="friends/accept">
            <input type="hidden" name="friendId" value="<%= user.id %>" />
            <input type="hidden" name="friendUsername" value="<%= user.username %>" />
            <input type="submit" value="Accept Request" />
          </form>

        <% } else if (friendship.status == 'pending') { %> 
          <!--  user sent THEM a request, show Pending -->
          <button disabled>Pending</button>

        <% } else if (friendship.status == 'accepted') { %> 
          <!-- Already friends -->
          <button disabled>Friend</button>
        <% } %>
      </div>

    <% } %> <!-- End of check -->

    <h2>Recent Workouts</h2>

    <% if (workouts && workouts.length > 0) { %>
        <% workouts.forEach(workout => { %>
              <strong>Type:</strong> <%= workout.type %> 
              <% if (workout.date_logged) { %>
                 on <%= new Date(workout.date_logged).toDateString() %>
              <% } %>
            </div>

            <div>
              <strong>Achieved:</strong>
              <% 
                // Collect available metrics into an array
                let metrics = [];
                if (workout.distance !== null) metrics.push(workout.distance + " km");
                if (workout.reps !== null) metrics.push(workout.reps + " reps");
                if (workout.sets !== null) metrics.push(workout.sets + " sets");
              %>
              
              <!-- Output metrics (e.g., "5 km, 3 sets") -->
              <% if (metrics.length > 0) { %>
                <%= metrics.join(", ") %>
              <% } %>
              
              <!-- Output duration (e.g., " in 30 minutes") -->
              <% if (workout.duration !== null) { %>
                 in <%= workout.duration %> minutes
              <% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No workouts logged yet.</p>
    <% } %>

  </body>
</html>